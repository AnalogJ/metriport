# This should be run from the context of the root of the monorepo
FROM node:18

RUN apt-get update -y && \
    apt-get install -y curl autoconf automake libtool pkg-config build-essential

WORKDIR /usr/src
RUN git clone https://github.com/openvenues/libpostal
WORKDIR /usr/src/libpostal
COPY packages/api/build_libpostal.sh /usr/src/libpostal/build_libpostal.sh
RUN ["chmod", "+x", "/usr/src/libpostal/build_libpostal.sh"]
RUN ./build_libpostal.sh
RUN ldconfig
RUN npm install -g node-gyp

WORKDIR /usr/src/app
COPY package*.json ./
COPY tsconfig.json ./
COPY packages ./packages
COPY packages/api/.env ./packages/api/
RUN ls -a
# install external dependencies from the package-lock file
RUN npm ci --ignore-scripts --no-fund

# build local dependencies
RUN npm run build -w packages/commonwell-sdk && npm run build -w packages/api-sdk
RUN npm rebuild node-postal
# build/run the api
WORKDIR /usr/src/app/packages/api
RUN ls -a
EXPOSE 8080
EXPOSE 9229
CMD ["npm","run","dev"]
