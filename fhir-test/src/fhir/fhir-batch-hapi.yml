config:
  target: "{{ $processEnvironment.HAPI_URL }}"
  http:
    timeout: 120
  plugins:
    # https://www.artillery.io/docs/guides/plugins/plugin-publish-metrics
    publish-metrics:
      - type: cloudwatch
        region: "{{ $processEnvironment.REGION }}"
  phases:
    # two users, one every 3 seconds
    - duration: 6
      arrivalCount: 2
      name: Warm up
    # - duration: 60
    #   arrivalRate: 10
    #   rampTo: 50
    # name: Ramp up load
  variables:
    tenantId: "{{ $processEnvironment.HAPI_TENANT_ID }}"
  processor: "./fhir-batch.js"

scenarios:
  - name: "FHIR Batch HAPI"
    beforeScenario: generatePostBody
    flow:
      - log: "Posting batch {{ requestFile }}"
      - post:
          url: "/fhir/{{tenantId}}/"
          headers:
          json: "{{ requestBody }}"

      # - get:
      #     url: '/fhir/{{tenantId}}/Patient/31329'
