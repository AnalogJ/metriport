config:
  target: "{{ $processEnvironment.HAPI_URL }}"
  http:
    timeout: 60
  plugins:
    # https://www.artillery.io/docs/guides/plugins/plugin-publish-metrics
    publish-metrics:
      - type: cloudwatch
        region: "{{ $processEnvironment.REGION }}"
    # https://www.artillery.io/docs/guides/plugins/plugin-metrics-by-endpoint
    metrics-by-endpoint:
      # Group metrics by request name rather than URL:
      useOnlyRequestNames: true
  phases:
    - duration: 10
      arrivalRate: 2
      name: Warm up
    - duration: 60
      arrivalRate: 10
      rampTo: 50
      name: Ramp up load
    - duration: 120
      arrivalRate: 20
      rampTo: 100
      name: Ramp up load
  variables:
    tenantId: "{{ $processEnvironment.HAPI_TENANT_ID }}"

scenarios:
  - name: "FHIR CRUD HAPI"
    flow:
      - loop:
          - post:
              url: "/fhir/{{tenantId}}/Patient"
              headers:
              json:
                resourceType: Patient
                name:
                  - family: "{{ $randomString() }}"
              capture:
                - json: "$.id"
                  as: "patientId"
                - json: "$.name[0].family"
                  as: "familyName"
              name: "Create Patient"
          - get:
              url: "/fhir/{{tenantId}}/Patient/{{ patientId }}"
              headers:
              name: "Get Patient by ID"
          - get:
              url: "/fhir/{{tenantId}}/Patient?name={{ familyName }}"
              headers:
              name: "Get Patient by name"
          - delete:
              url: "/fhir/{{tenantId}}/Patient/{{ patientId }}"
              headers:
              name: "Delete Patient"
        count: 2
